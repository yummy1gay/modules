#meta developer: @yummy_gay
#channel tg: @yg_modules
#st1tl cl0wn

#â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#â•šâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
#â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
#â–‘â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—
#â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
#â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â–‘â•šâ•â•â•â•â•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â–‘

import asyncio
import time
from telethon.tl.types import Message
from .. import loader, utils

class yg_timer(loader.Module):
    """ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°Ğ¼Ğ¸."""

    strings = {"name": "yg_timer"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            "update_interval", 11, "Interval for updating the timer display in seconds"
        )
        self.timers = {}
        self.timer_counter = 0

    async def start_timer(self, message, timer_id, duration, initial_time_text):
        start_time = time.time()
        while time.time() - start_time < duration:
            remaining_time = int(duration - (time.time() - start_time))
            hours, remainder = divmod(remaining_time, 3600)
            minutes, seconds = divmod(remainder, 60)
            timer_message = (
                f"<emoji document_id=5872756762347573066>â²</emoji> <b>Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€</b> <code>#{timer_id}</code>\n"
                f"<emoji document_id=5451732530048802485>â³</emoji> <b>Ğ—Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ:</b> <code>{initial_time_text}</code>\n"
                f"<emoji document_id=5469741319330996757>ğŸ’«</emoji> <b>ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ:</b> <code>{hours:02}:{minutes:02}:{seconds:02}</code>\n\n"
                f"<i>Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ {self.config['update_interval']} ÑĞµĞºÑƒĞ½Ğ´ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ)</i>"
            )
            await message.edit(timer_message)
            await asyncio.sleep(self.config["update_interval"])
            if timer_id not in self.timers or not self.timers[timer_id]:
                return
        await message.edit(f"<emoji document_id=5427009714745517609>âœ…</emoji> <b>Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€</b> <code>#{timer_id}</code> <b>Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!</b>\n<b>Ğ—Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ¾!</b>")

    @loader.unrestricted
    async def timercmd(self, message: Message):
        """<Ğ²Ñ€ĞµĞ¼Ñ> - ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€"""
        args = utils.get_args(message)
        if len(args) < 2:
            await utils.answer(message, "<emoji document_id=5465665476971471368>âŒ</emoji> <b>ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğµ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:</b> <code>.timer 1 Ñ‡Ğ°Ñ</code>")
            return

        time_amount = float(args[0])
        time_unit = args[1].lower()
        if time_unit.endswith("ÑĞµĞº") or time_unit.endswith("s"):
            duration = time_amount
            initial_time_text = f"{time_amount} ÑĞµĞº"
        elif time_unit.endswith("Ğ¼Ğ¸Ğ½") or time_unit.endswith("m"):
            duration = time_amount * 60
            initial_time_text = f"{time_amount} Ğ¼Ğ¸Ğ½"
        elif time_unit.endswith("Ñ‡Ğ°Ñ") or time_unit.endswith("h"):
            duration = time_amount * 3600
            initial_time_text = f"{time_amount} Ñ‡Ğ°Ñ"
        elif time_unit.endswith("Ğ´ĞµĞ½ÑŒ") or time_unit.endswith("d"):
            duration = time_amount * 86400
            initial_time_text = f"{time_amount} Ğ´ĞµĞ½ÑŒ"
        else:
            await utils.answer(message, "<emoji document_id=5465665476971471368>âŒ</emoji> <b>ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ÑĞµĞº, Ğ¼Ğ¸Ğ½, Ñ‡Ğ°Ñ, Ğ´ĞµĞ½ÑŒ Ğ¸Ğ»Ğ¸ Ğ¸Ñ… Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸</b>")
            return

        self.timer_counter += 1
        timer_id = self.timer_counter
        timer_message = await utils.answer(
            message, f"Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ #{timer_id}\nĞ—Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: {initial_time_text}\nĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ: 00:00:00\nĞ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ {self.config['update_interval']} ÑĞµĞºÑƒĞ½Ğ´"
        )
        self.timers[timer_id] = True

        await asyncio.create_task(self.start_timer(timer_message, timer_id, duration, initial_time_text))

    @loader.unrestricted
    async def stoptimercmd(self, message: Message):
        """<Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°> - Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€"""
        args = utils.get_args(message)
        if not args:
            await utils.answer(message, "<emoji document_id=5465665476971471368>âŒ</emoji> <b>Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ° Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸</b>")
            return

        try:
            timer_id = int(args[0])
            if timer_id in self.timers and self.timers[timer_id]:
                self.timers[timer_id] = False
                await utils.answer(message, f"<emoji document_id=5427009714745517609>âœ…</emoji> <b>Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€</b> <code>#{timer_id}</code> <b>oÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½</b>")
            else:
                await utils.answer(message, f"<emoji document_id=5465665476971471368>âŒ</emoji> <b>Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼</b> <code>#{timer_id}</code> <b>Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½</b>")
        except ValueError:
            await utils.answer(message, "<emoji document_id=5465665476971471368>âŒ</emoji> <b>ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°</b>")

    async def client_ready(self, client, db):
        self.client = client

    async def __unload(self):
        for timer_id in self.timers:
            self.timers[timer_id] = False

    async def client_ready(self, client, db):
        self.client = client
