#meta developer: @yummy_gay
#channel tg: @yg_modules
#st1tl cl0wn

#â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#â•šâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
#â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
#â–‘â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—
#â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•

import re
from .. import loader
import httpx
import asyncio
from telethon.tl.functions.channels import JoinChannelRequest

@loader.sudo
class FCKPricesMod(loader.Module):
    """ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ³Ğ¾ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ñ†ĞµĞ½Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‡Ğ¸ÑĞ»ÑÑ‚ÑÑ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… FCK Analytics"""

    strings = {"name": "yg_TokensPrice"}

    async def pricecmd(self, message):
        """<name> Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğµ"""
        try:
            args = message.raw_text.split(" ", 1)
            if len(args) < 2:
                await message.edit("<emoji document_id=4987934263182623512>ğŸ˜©</emoji> <b>Ğ Ğ³Ğ´Ğµ Ğ¸Ğ¼Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°? Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:</b> <code>.price *name*</code>")
                return
            
            name = args[1].strip().upper()
            await message.edit(f"<b>ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğµ {name}...</b> <emoji document_id=4988080790286894217>ğŸ«¥</emoji>")

            async with httpx.AsyncClient() as client:
                response = await client.get("https://api.kucoin.com/api/v1/prices?base=USD&currencies=TON")
                api_price = float(response.json().get("data", {}).get("TON"))

            async with message.client.conversation("FCKAnalyticsBot") as conv:
                sent_message = await conv.send_message(f"/price {name}")
                await asyncio.sleep(1)
                await sent_message.delete()

                response = await conv.get_response()

                if "not found!" in response.text:
                    await message.edit(f"<emoji document_id=5870657884844462243>âŒ</emoji> <b>Ğ¢Ğ¾ĞºĞµĞ½ {name} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ FCK Analytics!</b>")
                    await response.delete()
                    return
                
                data = response.text

                price_match = re.search(r"âš–ï¸ Price: .*? = (.*?) TON", data)
                change7_match = re.search(r"(ğŸ”¼|ğŸ”½) (.*?) \(7d\)", data)
                volume_match = re.search(r"ğŸ›¢ Volume \(24h\): (.*?)\n", data)
                totalvolume_match = re.search(r"ğŸ¦ Total volume \(24h\): (.*?)\n", data)

                if not (price_match and change7_match and volume_match and totalvolume_match):
                    raise ValueError("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ")

                price = price_match.group(1).strip()
                change7_emoji = change7_match.group(1)
                change7_emoji = "<emoji document_id=5456199025453709307>ğŸ“Š</emoji>" if change7_emoji == "ğŸ”½" else "<emoji document_id=5870930636742595124>ğŸ“Š</emoji>"
                change7 = float(change7_match.group(2).replace('%', ''))
                change1 = round(change7 / 7, 2)

                volume_data = volume_match.group(1)
                buy_sell_matches = re.findall(r"(buy|sell) - (.*?) TON", volume_data)
                if buy_sell_matches:
                    buy_sell_data = ", ".join([f"<b>{action}</b> -<code>{volume}</code> <emoji document_id=5188672371648634636>ğŸ‘›</emoji>" for action, volume in buy_sell_matches])
                else:
                    buy_sell_data = volume_data.strip()

                totalvolume = totalvolume_match.group(1)

                calculated_price = round(float(price) * api_price, 4)

                change1_symbol = "+" if change1 >= 0 else ""
                change7_symbol = "+" if change7 >= 0 else ""

                formatted_data = (
                    f"<emoji document_id=5873146865637133757>ğŸ¤</emoji> <b>Ğ¦ĞµĞ½Ğ° {name}:</b> <code>{price}</code> <b>TON (â‰ˆ{calculated_price:.4f}$)</b>\n"
                    f"{change7_emoji} <b>Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ (24Ñ‡):</b> <code>{change1_symbol}{change1}%</code>\n"
                    f"{change7_emoji} <b>Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ (7Ğ´):</b> <code>{change7_symbol}{change7}%</code>\n"
                    f"<emoji document_id=5870921681735781843>ğŸ“Š</emoji> <b>ĞĞ±ÑŠĞµĞ¼ (24Ñ‡):</b> {buy_sell_data}\n"
                    f"<emoji document_id=5870921681735781843>ğŸ“Š</emoji> <b>ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±ÑŠĞµĞ¼ (24Ñ‡):</b> <code>{totalvolume}</code>\n\n"
                    f"<emoji document_id=5873159368286932298>ğŸ”—</emoji> <b>Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸:</code> <b><a href='https://t.me/FCKAnalyticsBot'>FCK Analytics</a></b><b>,</b> <b><a href='https://www.kucoin.com/ru/price/TON'>KuCoin</a></b>"
                )

                await response.delete()

            await message.edit(formatted_data)

        except Exception as e:
            await message.edit(f"<b>ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:</b> <code>{str(e)}</code>")
